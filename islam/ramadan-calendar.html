<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>রমজান ক্যালেন্ডার</title>
    <script src="theme.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&family=Amiri:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
 <style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
:root {
    --primary-gradient: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
    --glass-bg: rgba(255, 255, 255, 0.75);
    --glass-border: rgba(255, 255, 255, 0.6);
    --text-primary: #1a202c;
    --text-secondary: #4a5568;
    --accent-color: #4c51bf;
    --accent-glow: rgba(76, 81, 191, 0.15);
    --card-bg: rgba(255, 255, 255, 0.9);
    --nav-bg: rgba(255, 255, 255, 0.9);
}
body.dark-mode {
    --primary-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 100%);
    --glass-bg: rgba(17, 25, 40, 0.85);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-primary: #f7fafc;
    --text-secondary: #a0aec0;
    --accent-color: #63b3ed;
    --accent-glow: rgba(99, 179, 237, 0.15);
    --card-bg: rgba(45, 55, 72, 0.8);
    --nav-bg: rgba(26, 32, 44, 0.9);
}
body {
    font-family: 'Hind Siliguri', sans-serif;
    background: var(--primary-gradient);
    background-attachment: fixed;
    min-height: 100vh;
    color: var(--text-primary);
    overflow: hidden;
}
.app-container {
    width: 100%;
    height: 100vh; height: 100dvh;
    display: flex;
    flex-direction: column;
    max-width: 600px;
    margin: 0 auto;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    box-shadow: 0 0 50px rgba(0,0,0,0.2);
    position: relative;
}
.header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--glass-border);
}
.header .back-button {
    cursor: pointer;
    font-size: 1.2rem;
    width: 30px;
    color: var(--accent-color);
    text-align: left;
    text-decoration: none;
}
.header .theme-toggle {
    cursor: pointer;
    font-size: 1.2rem;
    width: 30px;
    color: var(--accent-color);
    text-align: right;
    background: transparent;
    border: none;
}
.header .main-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--accent-color);
    flex: 1;
    text-align: center;
}
.scroll-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px 15px 100px 15px;
    scrollbar-width: none;
}
.scroll-content::-webkit-scrollbar { display: none; }

/* কার্ড */
.info-card {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--glass-border);
    box-shadow: 0 8px 32px rgba(0,0,0,0.06);
    text-align: center;
}
.info-card h2 {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 8px;
}
.info-card p {
    font-size: 1rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-weight: 600;
}

/* ফিক্সড টেবিল ডিজাইন - ব্যালেন্সড উইডথ */
.table-wrapper {
    overflow: hidden; 
    margin-bottom: 20px;
    border-radius: 12px;
    background: var(--card-bg);
    border: 1px solid var(--glass-border);
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    background: transparent;
}
th {
    background: var(--accent-color);
    color: #fff;
    font-weight: 600;
    padding: 12px 2px;
    font-size: 0.75rem;
    text-align: center;
    text-transform: uppercase;
    white-space: nowrap;
}
td {
    padding: 12px 2px;
    text-align: center;
    border-bottom: 1px solid var(--glass-border);
    color: var(--text-primary);
    background: transparent;
    transition: all 0.2s ease;
    white-space: nowrap;
    font-size: 0.78rem; /* সামান্য বড় করলাম পড়ার সুবিধার জন্য */
}

/* কলাম উইডথ অ্যাডজাস্টমেন্ট - রমজান বাড়ানো হয়েছে, সময় কমানো হয়েছে */
th:nth-child(1), td:nth-child(1) { width: 16%; } /* রমজান (একটু বাড়ালাম) */
th:nth-child(2), td:nth-child(2) { width: 23%; } /* তারিখ */
th:nth-child(3), td:nth-child(3) { width: 17%; } /* বার */
th:nth-child(4), td:nth-child(4) { width: 22%; } /* সেহরি (একটু কমালাম) */
th:nth-child(5), td:nth-child(5) { width: 22%; } /* ইফতার (একটু কমালাম) */

.col-serial { font-weight: 700; color: var(--accent-color); }
.col-date { font-weight: 700; }
.col-day { color: var(--text-secondary); font-size: 0.7rem; }

.col-sehri, .col-iftar { 
    font-family: 'Poppins', sans-serif; 
    font-weight: 600; 
    color: #2c7a7a; 
}
body.dark-mode .col-sehri,
body.dark-mode .col-iftar { color: #4db8b8; }

/* টেবিলের হোভার ও জেব্রা */
tbody tr:nth-child(even) { background: rgba(0, 0, 0, 0.02); }
body.dark-mode tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }
tbody tr:hover { background: var(--accent-glow); }
tbody tr:last-child td { border-bottom: none; }

/* স্কেলিটন */
.skeleton {
    background: linear-gradient(90deg, var(--glass-border) 25%, rgba(128,128,128,0.1) 50%, var(--glass-border) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    color: transparent !important;
    border-radius: 4px;
}
.skeleton-row { height: 45px; margin: 8px; border-radius: 8px; }
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* ডিসক্লেইমার */
.disclaimer {
    background: rgba(255, 243, 205, 0.8);
    color: #856404;
    padding: 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    text-align: center;
    margin-top: 20px;
    border: 1px solid #ffeeba;
    line-height: 1.4;
}
body.dark-mode .disclaimer {
    background: rgba(74, 85, 104, 0.5);
    color: #ecc94b;
    border-color: #744210;
}

/* পিডিএফ বাটন */
.pdf-download-btn {
    position: fixed;
    bottom: 25px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--accent-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px var(--accent-glow);
    z-index: 1001;
    border: 2px solid var(--glass-border);
    font-size: 1.2rem;
}

/* ত্রুটি বার্তা */
.error-msg {
    text-align: center;
    padding: 30px 15px;
    color: var(--text-secondary);
    background: var(--card-bg);
    border-radius: 15px;
}
</style>

</head>
<body>
<div class="app-container">
    <!-- হেডার -->
    <div class="header">
        <a href="index.html" class="back-button"><i class="fas fa-arrow-left"></i></a>
        <span class="main-title">রমজান ক্যালেন্ডার</span>
        <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
    </div>

    <!-- স্ক্রল কন্টেন্ট -->
    <div class="scroll-content" id="mainContent">
        <!-- ইনফো কার্ড -->
        <div class="info-card">
            <h2 id="hijriYearLabel" class="skeleton">রমজান ----</h2>
            <p id="locationLabel" class="skeleton"><i class="fas fa-map-marker-alt"></i> লোকেশন লোড হচ্ছে...</p>
        </div>

        <!-- টেবিল র‍্যাপার -->
        <div class="table-wrapper" id="tableWrapper">
            <!-- স্কেলিটন লোডার -->
            <div class="loader-container" id="skeletonLoader">
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
                <div class="skeleton skeleton-row"></div>
            </div>
            <!-- আসল টেবিল (প্রাথমিকভাবে লুকানো) -->
            <table id="ramadanTable" style="display: none;">
                <thead>
                    <tr>
                        <th>রমজান</th>
                        <th>তারিখ</th>
                        <th>বার</th>
                        <th>সেহরি</th>
                        <th>ইফতার</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- জাভাস্ক্রিপ্ট ডায়নামিকভাবে ভরবে -->
                </tbody>
            </table>
        </div>

        <!-- ডিসক্লেইমার টেক্সট -->
        <div class="disclaimer" id="disclaimerText" style="display: none;">
            <i class="fas fa-info-circle"></i> চাঁদ দেখার উপর নির্ভরশীল
        </div>
    </div>

    <!-- পিডিএফ ডাউনলোড বাটন -->
    <div class="pdf-download-btn" id="pdfBtn" style="display: none;">
        <i class="fas fa-file-pdf"></i>
    </div>
</div>

<!-- jspdf ও autotable লাইব্রেরি -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
    (function() {
        // ----- কনফিগারেশন -----
        const CONFIG = {
            API_BASE: "https://api.aladhan.com/v1"
        };

        // ----- স্টেট -----
        const state = {
            lat: null,
            lon: null,
            areaNameBn: "অজানা স্থান",
            areaNameEn: "Bangladesh",
            hijriYear: "",
            ramadanDataRaw: []
        };

        // ----- ইউটিলিটি ফাংশন (index.html থেকে নেওয়া) -----
        const utils = {
            banglaMonths: ['জানু', 'ফেব্রু', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুল', 'আগস্ট', 'সেপ্টে', 'অক্টো', 'নভে', 'ডিসে'],
            weekDaysBn: {
                'Saturday': 'শনি', 'Sunday': 'রবি', 'Monday': 'সোম',
                'Tuesday': 'মঙ্গল', 'Wednesday': 'বুধ', 'Thursday': 'বৃহস্পতি', 'Friday': 'শুক্র'
            },
            formatTimeAmPm: (timeStr) => {
                if (!timeStr) return '--:--';
                let [h, m] = timeStr.split(':').map(Number);
                const suffix = h >= 12 ? 'PM' : 'AM';
                h = h % 12 || 12;
                return `${h}:${m.toString().padStart(2,'0')} ${suffix}`;
            },
            getMinutes: (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            },
            minsToTime: (mins) => {
                let h = Math.floor(mins / 60) % 24;
                let m = mins % 60;
                return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
            },
            cleanTimeStr: (str) => str.split(' ')[0]
        };

        // ----- ডিওএম এলিমেন্ট -----
        const ui = {
            hijriYearLabel: document.getElementById('hijriYearLabel'),
            locationLabel: document.getElementById('locationLabel'),
            skeletonLoader: document.getElementById('skeletonLoader'),
            ramadanTable: document.getElementById('ramadanTable'),
            tableBody: document.getElementById('tableBody'),
            disclaimerText: document.getElementById('disclaimerText'),
            pdfBtn: document.getElementById('pdfBtn'),
            mainContent: document.getElementById('mainContent'),
            tableWrapper: document.getElementById('tableWrapper')
        };

        // ----- জিওলোকেশন ফাংশন (index.html-এর মতো) -----
        const getPosition = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                } else {
                    navigator.geolocation.getCurrentPosition(
                        pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
                        err => reject(err),
                        { timeout: 10000, maximumAge: 0 }
                    );
                }
            });
        };

        // ----- এলাকার নাম বাংলায় আনার ফাংশন (রিভার্স জিওকোড) -----
        const fetchAreaNameBn = async (lat, lon) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&accept-language=bn`, {
                    headers: { 'User-Agent': 'IslamicHome/1.0' }
                });
                if (!res.ok) throw new Error("Location fetch failed");
                const data = await res.json();
                const addr = data.address;
                return addr.suburb || addr.neighbourhood || addr.village || addr.residential || addr.town || addr.city || addr.district || 'অজানা স্থান';
            } catch {
                return 'অজানা স্থান';
            }
        };

        // ----- এলাকার নাম ইংরেজিতে আনার ফাংশন (পিডিএফ-এর জন্য) -----
        const fetchAreaNameEn = async (lat, lon) => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&accept-language=en`, {
                    headers: { 'User-Agent': 'IslamicHome/1.0' }
                });
                if (!res.ok) throw new Error("Location fetch failed");
                const data = await res.json();
                const addr = data.address;
                return addr.city || addr.town || addr.state || 'Bangladesh';
            } catch {
                return 'Bangladesh';
            }
        };

        // ----- রমজানের মূল ডাটা আনা (হিজরি বছর ও ক্যালেন্ডার) -----
        const fetchRamadanData = async (lat, lon) => {
            try {
                // ১. আজকের তারিখ থেকে হিজরি বছর বের করি
                const today = new Date();
                const hijriUrl = `${CONFIG.API_BASE}/timings/${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}?latitude=${lat}&longitude=${lon}&method=1`;
                const hijriRes = await fetch(hijriUrl);
                if (!hijriRes.ok) throw new Error("Hijri year fetch failed");
                const hijriJson = await hijriRes.json();
                state.hijriYear = hijriJson.data.date.hijri.year;

                // ২. রমজান (মাস ৯) ও শাওয়াল (মাস ১০) এর ক্যালেন্ডার কল
                const [res9, res10] = await Promise.all([
                    fetch(`${CONFIG.API_BASE}/hijriCalendar/${state.hijriYear}/9?latitude=${lat}&longitude=${lon}&method=1&school=1`),
                    fetch(`${CONFIG.API_BASE}/hijriCalendar/${state.hijriYear}/10?latitude=${lat}&longitude=${lon}&method=1&school=1`)
                ]);

                if (!res9.ok || !res10.ok) throw new Error("Calendar fetch failed");

                const json9 = await res9.json();
                const json10 = await res10.json();

                // ৩. রমজানের ২ তারিখ থেকে শুরু করে শাওয়ালের ১ তারিখ যোগ করে ৩০ দিনের তালিকা বানানো
                let adjusted = json9.data.slice(1);          // ২ রমজান থেকে
                if (json10.data && json10.data.length > 0) {
                    adjusted.push(json10.data[0]);           // ১ শাওয়াল যোগ
                }
                state.ramadanDataRaw = adjusted;
            } catch (err) {
                console.error(err);
                throw err; // উপরের হ্যান্ডলারে যাবে
            }
        };

        // ----- ডাটা দিয়ে ডিওএম আপডেট -----
        const injectDOM = () => {
            // হিজরি বছর
            ui.hijriYearLabel.innerText = `রমজান ${state.hijriYear} হিজরি`;
            ui.hijriYearLabel.classList.remove('skeleton');

            // লোকেশন নাম
            ui.locationLabel.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${state.areaNameBn}`;
            ui.locationLabel.classList.remove('skeleton');

            // টেবিল বডি খালি করি
            ui.tableBody.innerHTML = '';

            state.ramadanDataRaw.forEach((dayData, idx) => {
                const timings = dayData.timings;
                const gregorian = dayData.date.gregorian;

                const sehriClean = utils.cleanTimeStr(timings.Fajr);
                const iftarClean = utils.cleanTimeStr(timings.Maghrib);

                // সেহরি −২ মিনিট, ইফতার +২ মিনিট
                const sehriAdjusted = utils.getMinutes(sehriClean) - 2;
                const iftarAdjusted = utils.getMinutes(iftarClean) + 2;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-serial">${idx + 1}</td>
                    <td class="col-date">${gregorian.day} ${utils.banglaMonths[parseInt(gregorian.month.number)-1]}</td>
                    <td class="col-day">${utils.weekDaysBn[gregorian.weekday.en] || gregorian.weekday.en}</td>
                    <td class="col-sehri">${utils.formatTimeAmPm(utils.minsToTime(sehriAdjusted))}</td>
                    <td class="col-iftar">${utils.formatTimeAmPm(utils.minsToTime(iftarAdjusted))}</td>
                `;
                ui.tableBody.appendChild(tr);
            });

            // লোডার লুকাও, টেবিল ও ডিসক্লেইমার দেখাও
            ui.skeletonLoader.style.display = 'none';
            ui.ramadanTable.style.display = 'table';
            ui.disclaimerText.style.display = 'block';
            ui.pdfBtn.style.display = 'flex';   // পিডিএফ বাটন দেখাও
        };

        // ----- পিডিএফ জেনারেট ফাংশন (আগের মতো) -----
        const generatePDF = async () => {
            if (state.ramadanDataRaw.length === 0) return;

            const btnIcon = ui.pdfBtn.querySelector('i');
            btnIcon.className = 'fas fa-spinner fa-spin';
            ui.pdfBtn.style.pointerEvents = 'none';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.width;

                const matrixData = state.ramadanDataRaw.map((dayData, idx) => {
                    const timings = dayData.timings;
                    const sehriClean = utils.cleanTimeStr(timings.Fajr);
                    const iftarClean = utils.cleanTimeStr(timings.Maghrib);
                    const sehriAdjusted = utils.formatTimeAmPm(utils.minsToTime(utils.getMinutes(sehriClean) - 2));
                    const iftarAdjusted = utils.formatTimeAmPm(utils.minsToTime(utils.getMinutes(iftarClean) + 2));
                    const englishDateStr = `${dayData.date.gregorian.day} ${dayData.date.gregorian.month.en}`;
                    const englishDayStr = dayData.date.gregorian.weekday.en;

                    return [
                        idx + 1,
                        englishDateStr,
                        englishDayStr,
                        sehriAdjusted,
                        iftarAdjusted
                    ];
                });

                doc.setFontSize(16);
                doc.setTextColor(76, 81, 191);
                doc.text(`Ramadan Schedule ${state.hijriYear} AH`, pageWidth / 2, 15, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Location: ${state.areaNameEn} | ${state.lat.toFixed(2)}, ${state.lon.toFixed(2)}`, pageWidth / 2, 21, { align: 'center' });

                doc.autoTable({
                    startY: 25,
                    head: [['Ramadan', 'Date', 'Day', 'Sehri', 'Iftar']],
                    body: matrixData,
                    theme: 'grid',
                    headStyles: { fillColor: [76, 81, 191], halign: 'center' },
                    styles: { fontSize: 9, halign: 'center' },
                    margin: { left: 15, right: 15 }
                });

                doc.save(`Ramadan_${state.hijriYear}_${state.areaNameEn.replace(/\s+/g, '')}.pdf`);
            } catch (err) {
                alert("PDF তৈরি করতে সমস্যা! কনসোল চেক করুন।");
                console.error(err);
            } finally {
                btnIcon.className = 'fas fa-file-pdf';
                ui.pdfBtn.style.pointerEvents = 'auto';
            }
        };

        // ----- মেইন বুট সিকোয়েন্স -----
        const bootSequence = async () => {
            // PDF বাটনে ক্লিক ইভেন্ট
            ui.pdfBtn.addEventListener('click', generatePDF);

            try {
                // ১. লোকেশন নেওয়া
                const pos = await getPosition();
                state.lat = pos.lat;
                state.lon = pos.lon;

                // ২. এলাকার নাম বাংলা ও ইংরেজিতে আনা (সমান্তরালে)
                const [bnName, enName] = await Promise.all([
                    fetchAreaNameBn(state.lat, state.lon),
                    fetchAreaNameEn(state.lat, state.lon)
                ]);
                state.areaNameBn = bnName;
                state.areaNameEn = enName;

                // ৩. রমজানের ডাটা আনা
                await fetchRamadanData(state.lat, state.lon);

                // ৪. ডিওএম আপডেট
                injectDOM();

            } catch (err) {
                console.error(err);
                // লোকেশন বা ডাটা লোড ব্যর্থ হলে ত্রুটি বার্তা দেখাও
                ui.skeletonLoader.style.display = 'none';
                ui.tableWrapper.style.display = 'none';
                ui.mainContent.innerHTML += `
                    <div class="error-msg" style="margin-top: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 15px; color: #e53e3e;"></i>
                        <h3 style="margin-bottom: 10px; color: var(--text-primary);">লোকেশন পাওয়া যায়নি</h3>
                        <p style="font-size: 0.95rem; color: var(--text-secondary);">আপনার অবস্থান শনাক্ত করা সম্ভব হয়নি। দয়া করে লোকেশন অনুমতি দিন অথবা আবার চেষ্টা করুন।</p>
                        <button onclick="location.reload()" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: var(--accent-color); color: white; text-decoration: none; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">পুনরায় চেষ্টা করুন</button>
                    </div>
                `;
            }
        };

        // পৃষ্ঠা লোড হলে শুরু
        window.addEventListener('load', bootSequence);
    })();
</script>
</body>
</html>
