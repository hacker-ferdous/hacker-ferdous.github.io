<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Web IDE</title>

    <!-- Brython and CodeMirror Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/python-hint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/scroll/annotatescrollbar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/matchesonscrollbar.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* CSS Variables for Theming */
        :root {
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Menlo', 'Consolas', 'Monaco', 'Liberation Mono', 'Lucida Console', monospace;
            --editor-font-size: 16px;
            --console-font-size: 14px;
        }

        /* Dark Theme (Default) */
        :root, body.dark-theme {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d2d;
            --bg-interactive: #3a3a3a;
            --border-color: #3c3c3c;
            --text-primary: #d4d4d4;
            --text-secondary: #a0a0a0;
            --text-tertiary: #7f7f7f;
            --accent-primary: #007acc;
            --run-btn-bg: #4caf50;
            --run-btn-hover-bg: #66bb6a;
            --error-color: #f44747;
            --error-line-bg: rgba(244, 71, 71, 0.15);
            --error-text-color: #ff8b8b;
            --highlight-bg: #5a5a00;
            --highlight-current-bg: #7a7a00;
        }

        /* Navy Blue Theme */
        body.navy-blue-theme {
            --bg-primary: #0a192f;
            --bg-secondary: #112240;
            --bg-tertiary: #193156;
            --bg-interactive: #2a446a;
            --border-color: #2a446a;
            --text-primary: #ccd6f6;
            --text-secondary: #8892b0;
            --text-tertiary: #5f749b;
            --accent-primary: #64ffda;
            --run-btn-bg: #00b894;
            --run-btn-hover-bg: #00d9ac;
            --error-color: #ff7979;
            --error-line-bg: rgba(255, 121, 121, 0.15);
            --error-text-color: #ff9191;
            --highlight-bg: #005f5f;
            --highlight-current-bg: #008c8c;
        }
        
        /* Dark Green Theme */
        body.dark-green-theme {
            --bg-primary: #0a1d12;
            --bg-secondary: #0f2b1d;
            --bg-tertiary: #16422b;
            --bg-interactive: #1f593b;
            --border-color: #246845;
            --text-primary: #a1e0b5;
            --text-secondary: #6f9c7f;
            --text-tertiary: #4e6f5a;
            --accent-primary: #50fa7b;
            --run-btn-bg: #4caf50;
            --run-btn-hover-bg: #57c25b;
            --error-color: #ff6e6e;
            --error-line-bg: rgba(255, 110, 110, 0.15);
            --error-text-color: #ff8a8a;
            --highlight-bg: #005a2e;
            --highlight-current-bg: #008543;
        }

        /* Basic Styles */
        *, *::before, *::after { box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0; font-family: var(--font-sans);
            background-color: var(--bg-primary); color: var(--text-primary);
            height: 100vh; width: 100vw; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Loader Styles */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-primary); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--border-color);
            border-top: 5px solid var(--accent-primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* IDE Layout */
        .ide-container { display: flex; flex-direction: column; height: 100%; }
        .ide-header {
            display: flex; align-items: center; justify-content: space-between; padding: 8px 16px;
            background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-logo { height: 32px; width: 32px; }
        .header-title h1 { font-size: 1.3rem; margin: 0; font-weight: 600; }
        .main-content { display: flex; flex-grow: 1; overflow: hidden; }
        .panel { display: flex; flex-direction: column; overflow: hidden; }
        .panel-editor { flex: 1 1 60%; min-width: 300px; }
        .panel-console { flex: 1 1 40%; background-color: var(--bg-primary); min-width: 250px; }
        .resizer { flex: 0 0 5px; background-color: var(--border-color); cursor: col-resize; transition: background-color 0.2s; }
        .resizer:hover, .resizer.active { background-color: var(--accent-primary); }

        /* Toolbar and Buttons */
        .toolbar {
            display: flex; align-items: center; gap: 8px; padding: 8px 12px;
            background-color: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .console-toolbar { background-color: var(--bg-secondary); justify-content: space-between; }
        .toolbar .label { font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); }
        .icon-button {
            display: inline-flex; align-items: center; justify-content: center;
            background-color: var(--bg-interactive); border: 1px solid var(--border-color);
            padding: 6px 12px; border-radius: 5px; cursor: pointer;
            transition: background-color 0.2s; color: var(--text-primary);
            font-size: 0.9rem; gap: 6px;
        }
        .icon-button:hover { background-color: var(--bg-secondary); }
        .icon-button:disabled { cursor: not-allowed; opacity: 0.6; }
        #run-button { background-color: var(--run-btn-bg); color: white; font-weight: 600; border-color: transparent; }
        #run-button:hover { background-color: var(--run-btn-hover-bg); }
        .file-input-native { display: none; }
        #settings-button { padding: 5px; background: none; border: none; }
        #settings-button svg { width: 24px; height: 24px; fill: var(--text-secondary); transition: fill 0.2s; }
        #settings-button:hover svg { fill: var(--text-primary); }

        /* Search Navigation Styles */
        .search-nav { display: none; align-items: center; gap: 6px; margin-left: auto; }
        .search-nav-btn { background: none; border: none; padding: 4px; cursor: pointer; }
        .search-nav-btn svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .search-nav-btn:hover svg { fill: var(--text-primary); }
        .search-nav-results { font-size: 0.8rem; color: var(--text-tertiary); }

        /* CodeMirror Editor Styles */
        .editor-area { flex-grow: 1; position: relative; overflow: hidden; }
        .CodeMirror {
            font-family: var(--font-mono) !important; height: 100%;
            background: var(--bg-primary); font-size: var(--editor-font-size);
        }
        .cm-s-monokai.CodeMirror { background: var(--bg-primary); color: var(--text-primary); }
        .CodeMirror-gutters { background: var(--bg-primary) !important; border-right: 1px solid var(--border-color); }
        .CodeMirror-cursor { border-left: 1px solid #d0d0d0 !important; }
        .error-line { background-color: var(--error-line-bg) !important; }
        .CodeMirror-hints { background: var(--bg-tertiary) !important; border: 1px solid var(--border-color) !important; }
        li.CodeMirror-hint-active { background: var(--accent-primary) !important; color: var(--bg-primary) !important;}
        .cm-matchhighlight { background-color: var(--highlight-bg) !important; }
        .cm-current-match { background-color: var(--highlight-current-bg) !important; }
        .editor-footer {
            padding: 4px 16px; font-size: 0.75rem; background-color: var(--bg-tertiary);
            border-top: 1px solid var(--border-color); color: var(--text-secondary);
            text-align: right; flex-shrink: 0;
        }

        /* Console Output Styles */
        #output {
            flex-grow: 1; padding: 1rem; font-family: var(--font-mono);
            font-size: var(--console-font-size); overflow-y: auto;
            color: var(--text-primary); white-space: pre-wrap; line-height: 1.5;
        }
        #output .log-error { color: var(--error-color); }
        #output .log-info { color: var(--text-tertiary); }
        #output mark { background-color: var(--highlight-bg); color: inherit; padding: 2px 0; border-radius: 2px; }
        #output mark.current-match { background-color: var(--highlight-current-bg); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box {
            background-color: var(--bg-secondary); border-radius: 12px;
            border: 1px solid var(--border-color); width: 90%; max-width: 650px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-close-btn {
            position: absolute; top: 15px; right: 20px; font-size: 2rem;
            color: var(--text-secondary); cursor: pointer; line-height: 1;
            border: none; background: none; z-index: 10;
        }
        .modal-close-btn:hover { color: var(--text-primary); }
        .modal-title {
            font-size: 1.4rem; color: var(--text-primary); margin: 0;
            border-bottom: 1px solid var(--border-color); padding: 20px 30px;
            flex-shrink: 0;
        }
        .modal-body { overflow-y: auto; padding: 25px 30px; }
        #error-modal-title { color: var(--error-text-color); }
        .modal-content { font-size: 1rem; line-height: 1.6; padding: 25px; }
        .modal-content code {
            background-color: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;
            font-family: var(--font-mono); color: #9cdcfe;
        }
        .modal-content strong { color: #f9d771; font-weight: 600; }
        
        /* Settings Form Styles */
        .settings-grid {
            display: grid; grid-template-columns: 200px 1fr;
            gap: 20px 25px; align-items: center; padding-top: 20px;
        }
        .settings-grid label {
            font-weight: 500; color: var(--text-secondary);
            font-size: 0.95rem; text-align: right; padding-right: 10px;
        }
        .settings-control {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            color: var(--text-primary); border-radius: 6px; padding: 10px;
            font-family: var(--font-sans); font-size: 0.9rem;
            width: 100%; transition: all 0.2s ease-in-out;
        }
        .settings-control:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.25);
        }
        .settings-control-group { display: flex; align-items: center; gap: 12px; }
        .settings-control-group input[type="number"] { width: 80px; }
        input[type="range"] { padding: 0; }
        input[type="checkbox"] {
            width: 20px; height: 20px;
            accent-color: var(--accent-primary); cursor: pointer;
        }
        .font-size-value {
            font-size: 0.9rem; color: var(--text-tertiary); margin-left: 10px;
            background-color: var(--bg-tertiary); padding: 4px 8px;
            border-radius: 4px; min-width: 40px; text-align: center;
        }
        .settings-divider {
            border: 0; height: 1px;
            background: var(--border-color); margin: 35px 0;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .main-content { flex-direction: column; }
            .resizer { display: none; }
            .panel-editor, .panel-console { flex: 1 1 50%; }
            .settings-grid { grid-template-columns: 1fr; gap: 15px; }
            .settings-grid label { margin-bottom: 0; text-align: left; }
        }
    </style>
</head>
<body onload="brython()">
    
    <!-- Page Loader -->
    <div id="loader-overlay"><div class="spinner"></div></div>

    <!-- Main IDE container -->
    <div class="ide-container">
        <!-- Header Section -->
        <header class="ide-header">
            <div class="header-left">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Python-logo-notext.svg/1200px-Python-logo-notext.svg.png" alt="Python Logo" class="header-logo">
                <div class="header-title"><h1>Python IDE</h1></div>
            </div>
            <div class="header-right">
                 <button id="settings-button" class="icon-button" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.22,5.72C8.63,5.96,8.1,6.29,7.6,6.67L5.21,5.71C4.99,5.62,4.74,5.69,4.62,5.91L2.7,9.23 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.8,11.69,4.78,12,4.78,12.31c0,0.31,0.02,0.62,0.07,0.93l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.38,2.91 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.38-2.91c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0.01,0.59-0.22l1.92-3.32c0.12-0.2,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                 </button>
            </div>
        </header>
        
        <!-- Main Content Area (Editor and Console) -->
        <main class="main-content">
            <!-- Editor Panel -->
            <div id="editor-panel" class="panel panel-editor">
                <div class="toolbar">
                    <button id="run-button" class="icon-button"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg> Run</button>
                    <button id="import-btn" class="icon-button">Import</button>
                    <input type="file" id="file-input" class="file-input-native" accept=".py">
                    <button id="export-btn" class="icon-button">Export</button>
                    <button id="clear-code-btn" class="icon-button">Clear</button>
                    <!-- Editor Search Navigation -->
                    <div id="editor-search-nav" class="search-nav">
                        <span id="editor-search-results" class="search-nav-results"></span>
                        <button id="editor-search-prev" class="search-nav-btn" title="Previous result">
                            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
                        </button>
                        <button id="editor-search-next" class="search-nav-btn" title="Next result">
                             <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="editor-area" id="editor-wrapper"></div>
                <div class="editor-footer"><span id="status-bar">Ln 1, Col 1</span></div>
            </div>

            <div id="resizer" class="resizer"></div>

            <!-- Console Panel -->
            <div id="console-panel" class="panel panel-console">
                 <div class="toolbar console-toolbar">
                    <span class="label">Console</span>
                     <!-- Console Search Navigation -->
                    <div id="console-search-nav" class="search-nav">
                        <span id="console-search-results" class="search-nav-results"></span>
                        <button id="console-search-prev" class="search-nav-btn" title="Previous result">
                            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
                        </button>
                        <button id="console-search-next" class="search-nav-btn" title="Next result">
                             <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                        </button>
                    </div>
                    <button id="clear-output-btn" class="icon-button">Clear Output</button>
                 </div>
                <div id="output"></div>
            </div>
        </main>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-content">
                <button id="error-modal-close-btn" class="modal-close-btn">&times;</button>
                <h3 id="error-modal-title" class="modal-title">Error Details</h3>
                <div id="error-modal-content"></div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <button id="settings-modal-close-btn" class="modal-close-btn">&times;</button>
            <h3 class="modal-title">IDE Settings</h3>
            <div class="modal-body">
                <!-- Visual Settings -->
                <div class="settings-grid">
                    <label for="theme-select">Theme</label>
                    <select id="theme-select" class="settings-control">
                        <option value="dark-theme">Dark (Classic)</option>
                        <option value="navy-blue-theme">Navy Blue</option>
                        <option value="dark-green-theme">Dark Green</option>
                    </select>

                    <label for="editor-font-size-slider">Editor Font Size</label>
                    <div>
                        <input type="range" id="editor-font-size-slider" min="12" max="24" step="1" class="settings-control">
                        <span id="editor-font-size-value" class="font-size-value">16px</span>
                    </div>

                    <label for="console-font-size-slider">Console Font Size</label>
                    <div>
                         <input type="range" id="console-font-size-slider" min="10" max="20" step="1" class="settings-control">
                         <span id="console-font-size-value" class="font-size-value">14px</span>
                    </div>
                    
                    <label for="font-mono-select">Editor Font Family</label>
                    <select id="font-mono-select" class="settings-control">
                        <option value="'Menlo', 'Consolas', 'Monaco', 'Liberation Mono', 'Lucida Console', monospace">Menlo/Consolas</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Fira Code', 'Fira Mono', monospace">Fira Code</option>
                        <option value="'Source Code Pro', monospace">Source Code Pro</option>
                        <option value="'Inconsolata', monospace">Inconsolata</option>
                    </select>
                </div>
                
                <hr class="settings-divider">
                <h4 class="modal-title" style="font-size: 1.2rem; border: none; padding: 0 0 15px 0;">Search & Navigation</h4>

                <!-- Search and Navigation Settings -->
                <div class="settings-grid" style="padding-top: 0;">
                    <label for="search-code-input">Search in Code</label>
                    <input type="search" id="search-code-input" class="settings-control" placeholder="Type and press Enter...">
                
                    <label for="search-console-input">Search in Console</label>
                    <input type="search" id="search-console-input" class="settings-control" placeholder="Type and press Enter...">
                    
                    <label for="case-sensitive-checkbox">Case Sensitive</label>
                    <div class="settings-control-group">
                        <input type="checkbox" id="case-sensitive-checkbox" class="settings-control" style="width: auto;">
                    </div>
                    
                    <label for="goto-line-input">Go to Line</label>
                    <div class="settings-control-group">
                         <input type="number" id="goto-line-input" min="1" class="settings-control">
                         <button id="goto-line-btn" class="icon-button">Go</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Section: CodeMirror Editor Initialization
            const placeholder = "# Enter your code here.";
            const codeMirrorEditor = CodeMirror(document.getElementById('editor-wrapper'), {
                value: placeholder, mode: 'python', theme: 'monokai', lineNumbers: true, autoCloseBrackets: true,
                extraKeys: { "Ctrl-Space": "autocomplete", "Ctrl-Enter": () => document.getElementById('run-button').click() },
            });
            window.codeMirrorEditor = codeMirrorEditor;

            codeMirrorEditor.on('focus', (cm) => { if (cm.getValue() === placeholder) cm.setValue(''); });
            codeMirrorEditor.on('blur', (cm) => { if (cm.getValue().trim() === '') cm.setValue(placeholder); });

            // Section: Resizable Panel Logic
            const resizer = document.getElementById('resizer');
            const editorPanel = document.getElementById('editor-panel');
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', () => { document.removeEventListener('mousemove', resize); }, { once: true });
            });
            function resize(e) {
                const containerRect = document.querySelector('.main-content').getBoundingClientRect();
                const editorWidth = e.clientX - containerRect.left;
                if (editorWidth > 200 && editorWidth < containerRect.width - 200) { editorPanel.style.flexBasis = `${editorWidth}px`; }
            }

            // Section: Settings Management
            const settings = {
                theme: 'dark-theme',
                editorFontSize: 16,
                consoleFontSize: 14,
                fontMono: "'Menlo', 'Consolas', 'Monaco', 'Liberation Mono', 'Lucida Console', monospace",
                caseSensitive: false
            };
            
            const settingsModalOverlay = document.getElementById('settings-modal-overlay');
            const themeSelect = document.getElementById('theme-select');
            const editorFontSizeSlider = document.getElementById('editor-font-size-slider');
            const consoleFontSizeSlider = document.getElementById('console-font-size-slider');
            const editorFontSizeValue = document.getElementById('editor-font-size-value');
            const consoleFontSizeValue = document.getElementById('console-font-size-value');
            const fontMonoSelect = document.getElementById('font-mono-select');
            const caseSensitiveCheckbox = document.getElementById('case-sensitive-checkbox');
            
            function applySettings() {
                document.body.className = settings.theme;
                codeMirrorEditor.setOption("theme", 'monokai');
                document.documentElement.style.setProperty('--editor-font-size', `${settings.editorFontSize}px`);
                document.documentElement.style.setProperty('--console-font-size', `${settings.consoleFontSize}px`);
                document.documentElement.style.setProperty('--font-mono', settings.fontMono);
                codeMirrorEditor.refresh();
            }

            function updateUIFromSettings() {
                 themeSelect.value = settings.theme;
                 editorFontSizeSlider.value = settings.editorFontSize;
                 editorFontSizeValue.textContent = `${settings.editorFontSize}px`;
                 consoleFontSizeSlider.value = settings.consoleFontSize;
                 consoleFontSizeValue.textContent = `${settings.consoleFontSize}px`;
                 fontMonoSelect.value = settings.fontMono;
                 caseSensitiveCheckbox.checked = settings.caseSensitive;
            }

            function saveSettings() {
                localStorage.setItem('ideSettings', JSON.stringify(settings));
            }

            function loadSettings() {
                const savedSettings = localStorage.getItem('ideSettings');
                if (savedSettings) { Object.assign(settings, JSON.parse(savedSettings)); }
                updateUIFromSettings();
                applySettings();
            }
            
            // Section: Settings Modal Event Listeners
            document.getElementById('settings-button').addEventListener('click', () => { settingsModalOverlay.style.display = 'flex'; });
            document.getElementById('settings-modal-close-btn').addEventListener('click', () => { settingsModalOverlay.style.display = 'none'; });
            settingsModalOverlay.addEventListener('click', (e) => { if(e.target === settingsModalOverlay) settingsModalOverlay.style.display = 'none'; });
            settingsModalOverlay.querySelector('.modal-box').addEventListener('click', (e) => e.stopPropagation());

            themeSelect.addEventListener('change', (e) => { settings.theme = e.target.value; applySettings(); saveSettings(); });
            editorFontSizeSlider.addEventListener('input', (e) => { settings.editorFontSize = e.target.value; editorFontSizeValue.textContent = `${settings.editorFontSize}px`; applySettings(); saveSettings(); });
            consoleFontSizeSlider.addEventListener('input', (e) => { settings.consoleFontSize = e.target.value; consoleFontSizeValue.textContent = `${settings.consoleFontSize}px`; applySettings(); saveSettings(); });
            fontMonoSelect.addEventListener('change', (e) => { settings.fontMono = e.target.value; applySettings(); saveSettings(); });
            caseSensitiveCheckbox.addEventListener('change', (e) => { settings.caseSensitive = e.target.checked; saveSettings(); });

            // Section: Search State and Logic
            const editorSearchNav = document.getElementById('editor-search-nav');
            const consoleSearchNav = document.getElementById('console-search-nav');

            let editorSearchState = { markers: [], current: -1 };
            let consoleSearchState = { matches: [], current: -1 };

            // Function to clear all search highlights and state
            function clearAllSearch() {
                // Clear editor search
                editorSearchState.markers.forEach(marker => marker.clear());
                editorSearchState = { markers: [], current: -1 };
                editorSearchNav.style.display = 'none';

                // Clear console search
                document.querySelectorAll('#output mark').forEach(mark => {
                     mark.outerHTML = mark.innerHTML;
                });
                document.getElementById('output').normalize();
                consoleSearchState = { matches: [], current: -1 };
                consoleSearchNav.style.display = 'none';
            }

            // Function to search in the code editor
            function searchInEditor(query) {
                clearAllSearch();
                if (!query) return;

                const cursor = codeMirrorEditor.getSearchCursor(query, {line: 0, ch: 0}, {caseFold: !settings.caseSensitive});
                while (cursor.findNext()) {
                    editorSearchState.markers.push(codeMirrorEditor.markText(cursor.from(), cursor.to(), { className: 'cm-matchhighlight' }));
                }

                if (editorSearchState.markers.length > 0) {
                    editorSearchNav.style.display = 'flex';
                    editorSearchState.current = 0;
                    navigateEditorSearch(0);
                }
            }
            
            // Function to navigate editor search results
            function navigateEditorSearch(index) {
                editorSearchState.markers.forEach(m => m.clear()); // Clear old styles
                
                // Re-apply markers with default class
                for(let i=0; i<editorSearchState.markers.length; i++){
                    const { from, to } = editorSearchState.markers[i].find();
                    const className = (i === index) ? 'cm-current-match' : 'cm-matchhighlight';
                    editorSearchState.markers[i] = codeMirrorEditor.markText(from, to, { className });
                }
                
                editorSearchState.current = index;
                const pos = editorSearchState.markers[index].find();
                codeMirrorEditor.scrollIntoView(pos.from, 100);
                document.getElementById('editor-search-results').textContent = `${index + 1} of ${editorSearchState.markers.length}`;
            }

            // Function to search in the console output
            function searchInConsole(query) {
                clearAllSearch();
                if (!query) return;
                
                const flags = settings.caseSensitive ? 'g' : 'gi';
                const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, flags);
                const output = document.getElementById('output');
                const walker = document.createTreeWalker(output, NodeFilter.SHOW_TEXT, null, false);
                
                let nodesToProcess = [];
                let node;
                while (node = walker.nextNode()) {
                     if (node.nodeValue.match(regex)) {
                        nodesToProcess.push(node);
                     }
                }
                
                nodesToProcess.forEach(node => {
                    const fragment = document.createDocumentFragment();
                    node.nodeValue.split(regex).forEach((part, i) => {
                        if (i % 2 === 1) { // It's a match
                           const mark = document.createElement('mark');
                           mark.textContent = part;
                           consoleSearchState.matches.push(mark);
                           fragment.appendChild(mark);
                        } else if(part) {
                           fragment.appendChild(document.createTextNode(part));
                        }
                    });
                    node.parentNode.replaceChild(fragment, node);
                });

                if (consoleSearchState.matches.length > 0) {
                    consoleSearchNav.style.display = 'flex';
                    consoleSearchState.current = 0;
                    navigateConsoleSearch(0);
                }
            }
            
            // Function to navigate console search results
            function navigateConsoleSearch(index) {
                consoleSearchState.matches.forEach(m => m.classList.remove('current-match'));
                
                const currentMatch = consoleSearchState.matches[index];
                currentMatch.classList.add('current-match');
                currentMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                consoleSearchState.current = index;
                document.getElementById('console-search-results').textContent = `${index + 1} of ${consoleSearchState.matches.length}`;
            }

            // Section: Search Input and Navigation Button Event Listeners
            document.getElementById('search-code-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') {
                    e.preventDefault();
                    searchInEditor(e.target.value);
                    settingsModalOverlay.style.display = 'none';
                }
            });
            document.getElementById('search-console-input').addEventListener('keydown', (e) => {
                 if(e.key === 'Enter') {
                    e.preventDefault();
                    searchInConsole(e.target.value);
                    settingsModalOverlay.style.display = 'none';
                }
            });
            
            // Editor navigation button bindings
            document.getElementById('editor-search-next').addEventListener('click', () => {
                if(editorSearchState.markers.length === 0) return;
                const nextIndex = (editorSearchState.current + 1) % editorSearchState.markers.length;
                navigateEditorSearch(nextIndex);
            });
            document.getElementById('editor-search-prev').addEventListener('click', () => {
                if(editorSearchState.markers.length === 0) return;
                const prevIndex = (editorSearchState.current - 1 + editorSearchState.markers.length) % editorSearchState.markers.length;
                navigateEditorSearch(prevIndex);
            });
            
            // Console navigation button bindings
            document.getElementById('console-search-next').addEventListener('click', () => {
                if(consoleSearchState.matches.length === 0) return;
                const nextIndex = (consoleSearchState.current + 1) % consoleSearchState.matches.length;
                navigateConsoleSearch(nextIndex);
            });
             document.getElementById('console-search-prev').addEventListener('click', () => {
                if(consoleSearchState.matches.length === 0) return;
                const prevIndex = (consoleSearchState.current - 1 + consoleSearchState.matches.length) % consoleSearchState.matches.length;
                navigateConsoleSearch(prevIndex);
            });
            
            // Section: Go To Line Logic
            function goToLine() {
                 const lineInput = document.getElementById('goto-line-input');
                 const lineNum = parseInt(lineInput.value, 10);
                 if (lineNum > 0 && lineNum <= codeMirrorEditor.lineCount()) {
                     codeMirrorEditor.setCursor(lineNum - 1, 0);
                     codeMirrorEditor.focus();
                     settingsModalOverlay.style.display = 'none';
                     lineInput.value = '';
                 }
            }
            document.getElementById('goto-line-btn').addEventListener('click', goToLine);
            document.getElementById('goto-line-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') goToLine(); });

            // Section: Final Setup
            loadSettings(); 
            document.getElementById('loader-overlay').style.display = 'none';
        });
    </script>
    
    <!-- Brython (Python in Browser) Script -->
    <script type="text/python">
        # Section: Python environment setup
        from browser import document, html, window, aio
        import sys
        from io import StringIO
        import traceback
        import re

        editor = window.codeMirrorEditor
        run_button = document["run-button"]
        output_console = document["output"]
        
        error_modal_overlay = document["error-modal-overlay"]
        error_modal_title = document["error-modal-title"]
        error_modal_content = document["error-modal-content"]
        error_modal_close_btn = document["error-modal-close-btn"]
        
        last_error_line_marker = None
        placeholder_text = "# Enter your code here."

        # Section: Error handling and modal display
        def show_error_modal(title, message_html):
            error_modal_title.text = title
            error_modal_content.html = message_html
            error_modal_overlay.style.display = "flex"

        def hide_error_modal(ev=None):
            error_modal_overlay.style.display = "none"

        def get_error_explanation(error_name, error_value_str, line_num):
            title = f"Details for {error_name}"
            
            if error_name == "NameError":
                match = re.search(r"name '(.+)' is not defined", error_value_str)
                if match:
                    var_name = match.group(1)
                    return title, f"""In <strong>line {line_num}</strong> of your code, you're trying to use a variable named <code>{var_name}</code> which has not been defined yet.<br><br><strong>Possible Solution:</strong> Ensure that you have assigned a value to this variable before using it, or check for any spelling mistakes."""
            elif error_name == "SyntaxError":
                return title, f"""There is a structural error in <strong>line {line_num}</strong>. Python cannot understand this line of code.<br><br><strong>Possible Solution:</strong> Look for missing punctuation like colons (<code>:</code>), commas (<code>,</code>), or unbalanced brackets (<code>()</code>, <code>[]</code>) near this line."""
            elif error_name == "TypeError":
                 match = re.search(r"unsupported operand type\(s\) for (.+): '(.+)' and '(.+)'", error_value_str)
                 if match:
                     op, type1, type2 = match.group(1).strip(), match.group(2), match.group(3)
                     return title, f"""You are performing an invalid operation on <strong>line {line_num}</strong>. An operation (<code>{op}</code>) is being attempted between a <code>{type1}</code> and a <code>{type2}</code>, which is not supported. For example, you cannot add a number and a string directly."""
            elif error_name == "IndexError":
                return title, f"""On <strong>line {line_num}</strong>, you are trying to access an item in a list or tuple using an index that is out of bounds.<br><br><strong>Note:</strong> Remember that indexing starts from 0. If a list has 3 items, its valid indices are 0, 1, and 2."""
            elif error_name == "IndentationError":
                return title, f"""Python uses indentation (spaces) to define code blocks (like in 'if', 'for', 'def'). The number of spaces at the beginning of <strong>line {line_num}</strong> is incorrect."""
            elif error_name == "AttributeError":
                match = re.search(r"'(.+)' object has no attribute '(.+)'", error_value_str)
                if match:
                    obj_type, attr_name = match.group(1), match.group(2)
                    return title, f"""On <strong>line {line_num}</strong>, you are trying to access an attribute or method named <code>.{attr_name}</code> on a <code>{obj_type}</code> object, but it does not exist.<br><br><strong>Possible Reason:</strong> You may have misspelled the method name (e.g., using <code>.add()</code> instead of <code>.append()</code> for a list) or the object is not the type you think it is."""

            generic_message = {"ValueError": "A function received an argument with the correct data type but an inappropriate value.", "KeyError": "You are trying to access a value in a dictionary using a key that does not exist.", "ZeroDivisionError": "The code is attempting to divide a number by zero.", "FileNotFoundError": "The program is trying to open a file at a specified path that could not be found."}
            
            if error_name in generic_message:
                 return title, f"""An <strong>{error_name}</strong> occurred near <strong>line {line_num}</strong>.<br><br><strong>Common Cause:</strong> {generic_message[error_name]}"""

            return title, f"""An <strong>{error_name}</strong> occurred at <strong>line {line_num}</strong>.<br><br><strong>Details:</strong> {error_value_str}"""
        
        def clear_error_highlight(*args):
            global last_error_line_marker
            if last_error_line_marker is not None:
                editor.removeLineClass(last_error_line_marker, 'wrap', 'error-line')
                last_error_line_marker = None
        
        # Section: Main code execution logic
        async def run_python(ev):
            global last_error_line_marker
            clear_error_highlight()
            code = editor.getValue()
            if code == placeholder_text or not code.strip(): return 

            run_button.disabled = True
            output_console.clear()
            output_console <= html.SPAN(">>> Running script...", Class="log-info")
            await aio.sleep(0.01)

            old_stdout = sys.stdout
            sys.stdout = captured_output = StringIO()
            
            try:
                exec(code, {})
                result = captured_output.getvalue()
                output_console.html += f"<br>{result if result else '<span class=log-info>Execution finished with no output.</span>'}"
            except Exception:
                exc_type, exc_value, exc_tb = sys.exc_info()
                tb_lines = traceback.format_exception(exc_type, exc_value, exc_tb)
                error_message = "".join(tb_lines)
                sanitized_error = error_message.replace("<", "&lt;").replace(">", "&gt;")
                output_console.html += f"<br><span class='log-error'>{sanitized_error}</span>"
                
                line_num = -1
                match = re.search(r'File "<string>", line (\d+)', error_message)
                if match:
                    line_num = int(match.group(1))
                    if line_num > 0:
                        last_error_line_marker = line_num - 1
                        editor.addLineClass(last_error_line_marker, 'wrap', 'error-line')
                
                error_name = exc_type.__name__
                error_value_str = str(exc_value)
                title, explanation = get_error_explanation(error_name, error_value_str, line_num)
                show_error_modal(title, explanation)

            finally:
                sys.stdout = old_stdout
                run_button.disabled = False
        
        # Section: File I/O and utility functions
        def clear_code(ev):
            editor.setValue('')
            editor.focus()

        def import_file(ev):
            file = ev.target.files[0]
            if not file: return
            reader = window.FileReader.new()
            
            def on_load(event):
                editor.setValue(event.target.result)
                window.codeMirrorEditor.getDoc().clearHistory()
                document["file-input"].value = ""
            
            reader.bind('load', on_load)
            reader.readAsText(file)

        def export_file(ev):
            code = editor.getValue()
            if code == placeholder_text: code = ""
            blob = window.Blob.new([code], {"type": "text/x-python;charset=utf-8"})
            window.saveAs(blob, "script.py")

        def update_status_bar(cm, _=None):
            cursor = cm.getCursor()
            document['status-bar'].text = f"Ln {cursor.line + 1}, Col {cursor.ch + 1}"

        # Section: Bind all events to elements
        def setup_bindings():
            run_button.bind("click", lambda ev: aio.run(run_python(ev)))
            document["import-btn"].bind("click", lambda ev: document["file-input"].click())
            document["file-input"].bind("change", import_file)
            document["export-btn"].bind("click", export_file)
            document["clear-code-btn"].bind("click", clear_code)
            document["clear-output-btn"].bind("click", lambda ev: output_console.clear())
            
            editor.on('cursorActivity', update_status_bar)
            editor.on('change', clear_error_highlight)
            
            error_modal_close_btn.bind("click", hide_error_modal)
            error_modal_overlay.bind("click", hide_error_modal)
            document.select_one("#error-modal-overlay .modal-box").bind("click", lambda ev: ev.stopPropagation())

            update_status_bar(editor)
        
        # Initialize the application
        setup_bindings()
    </script>
</body>
</html>
